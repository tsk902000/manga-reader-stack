services:
  # --- THE DOWNLOADER ---
  suwayomi:
    image: ghcr.io/suwayomi/suwayomi-server:preview
    container_name: suwayomi
    restart: unless-stopped
    ports:
      - "4567:4567"
    volumes:
      - ./manga-library:/home/suwayomi/.local/share/Tachidesk/downloads
      - ./suwayomi/files:/home/suwayomi/.local/share/Tachidesk
    environment:
      - TZ=${TZ}
      - DOWNLOAD_AS_CBZ=true
      - AUTH_MODE=${SUWAYOMI_AUTH_MODE}
      - AUTH_USERNAME=${ADMIN_EMAIL}
      - AUTH_PASSWORD=${ADMIN_PASSWORD}
      - FLARESOLVERR_ENABLED=true
      - FLARESOLVERR_URL=http://flaresolverr:8191
      - DATABASE_TYPE=POSTGRESQL
      - DATABASE_URL=${DB_URL}
      - DATABASE_USERNAME=${DB_USER}
      - DATABASE_PASSWORD=${DB_PASSWORD}
      - USE_HIKARI_CONNECTION_POOL=true 
    depends_on:
      suwadb:
        condition: service_healthy
        restart: true
    user: "${PUID}:${PGID}"

  # --- THE LIBRARIAN ---
  komga:
    image: gotson/komga:latest
    container_name: komga
    restart: unless-stopped
    ports:
      - "25600:25600"
    volumes:
      - ./komga/config:/config
      - ./manga-library:/data
    environment:
      - TZ=${TZ}
      # Note: Komga uses these for initial setup or internal auth
      - KOMGA_USER=${ADMIN_EMAIL}
      - KOMGA_PASSWORD=${ADMIN_PASSWORD}
    user: "${PUID}:${PGID}"
    restart: on-failure:3

  # --- THE METADATA FETCHED ---
  komf:
    image: sndxr/komf:latest
    container_name: komf
    restart: unless-stopped
    ports:
      - "8085:8085"
    volumes:
      - ./komf/config:/config
    environment:
      - TZ=${TZ}
      - KOMF_KOMGA_BASE_URL=http://komga:25600
      - KOMF_KOMGA_USER=${ADMIN_EMAIL}
      - KOMF_KOMGA_PASSWORD=${ADMIN_PASSWORD}
    user: "${PUID}:${PGID}"
    restart: on-failure:3
  flaresolverr:
    # DockerHub mirror flaresolverr/flaresolverr:latest
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_HTML=${LOG_HTML:-false}
      - CAPTCHA_SOLVER=${CAPTCHA_SOLVER:-none}
      - TZ=Europe/London
    ports:
      - "8191:8191"
    restart: unless-stopped 

  suwadb:
    image: postgres:17-alpine
    container_name: suwadb
    restart: unless-stopped
    # Use environment variables from the .env file
    environment:
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=${DB_NAME}
      - PGDATA=/var/lib/postgresql/data/pgdata
    ports:
      - "15432:5432"
    volumes:
      # Maps local folder 'postgres_data' to internal DB folder
      - ./postgres_data:/var/lib/postgresql/data
    user: "${PUID}:${PGID}"
    restart: on-failure:3
    # Healthcheck ensures other apps don't connect until DB is "Ready"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
    